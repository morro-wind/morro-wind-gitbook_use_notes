# 基础

周期

从“决定做某种修改”到“该修改结果正式上线”的这段时间称为周期时间（cycle time）。对任何项目而言，它都是一个极为重要的度量标准。

周期时间的度量单位是周或者月，而且发布过程也是不可重复或不可靠的。

创建一个完全自动化、可重复且可靠的过程，让变更顺利地经过构建、部署、测试、和发布过程。对于某一关键的修改，团队做到了小时级别甚至分钟级别的发布。在这里，自动化是关键。

讲述如何缩短从想法到商业价值实现的时间，并使之更安全，从而彻底改变软件的交付方式。且具备易于理解与风险可量化的特点。

目标是改变软件交付方式，将其由手工操作变成一种可靠、可预期、可视化的过程并在很大程度上实现自动化的流程。

低风险软件交付的机制和过程作为其组成部分。

首次发布后交付软件的成本包括技术支持、维护、增加新功能和修复缺陷的成本。迭代方式更是如此，因首次发布只会给用户提供价值的最小功能集合。

#读者对象及内容
一个主要目标是改善负责软件交付的相关人员之间的协作，尤其是开发人员、测试人员、系统和数据库管理员以及经理。

内容包括配置管理、源代码控制、发布计划、审计、符合性和集成，以及构建、测试和部署流程的自动化。


#部署流水
简单的部署流水线

提交阶段  
编译       
单元测试    
分析  
构建安装包  

自动化验收测试  

自动化容量测试  

手工测试
演示
探索性测试

发布

部署流水线三个目标：  
让软件构建、部署、测试和发布过程对所有人可见。  
改善了反馈，以便在整个过程中更早地发现并解决问题。  
使团队能够通过一个完全自动化的过程在任意环境上部署和发布任意版本。  



软件应该满足其业务目的。质量不等于完美，伏尔泰所说“追求完美是把事情做好的大敌”，但我们的目标应该一直是交付质量足够高的软件，给客户带来价值。因此，尽快的交付软件很重要，保证一定的质量是基础。  


**对于频繁地自动化发布来说，反馈是至关重要的。关于反馈的三个标准：  
无论什么样的修改都应该触发反馈流程；  
反馈应该尽快发出；  
交付团队必须接收反馈，并依据它作出相应的行动。**  


编程语言可以通过语法检查来发现编译问题，单元测试可以验证代码中有没有输入错误。将配置信息放在版本控制系统中。  
#软件交付原则  
为软件的发布创建一个可重复且可靠的过程  

      几乎将所有事情自动化；
      将构建、部署、测试和发布软件所需的东西全部纳入到版本控制管理中。  

将几乎所有事情自动化  

      自动化是部署流水线的前提条件。
      不需要把所有的东西一次性的全部自动化。
      应该看一下在构建、部署、测试和发布过程中，哪个环节是瓶。
      随着时间的推移，最终将所有环节全部自动化。

把所有的东西都纳入版本控制  
提前并频繁地做让你感到痛苦事（持续改进）  
内建质量  

      越早发现缺陷，修复它们的成本越低。一旦发现缺陷，马上着手修复。
      测试不是一个阶段，当然也不应该开发结束之后才开始。
      测试也不纯粹或主要是测试人员的领域。交付团队的每个人都应该对应用程序的质量负责。

“DONE” 意味着“已发布”  

      一个特性只有交到用户手中才能算“Done”。这是持续部署实践背后的动机之一。
      对于敏捷交付团队来说，“Done”意味着软件已经部署到生产环境上。
      没有“已经完成80%”这一说法。任何事情要么是完成了，要么就是没完成。
      一件事情的完成与否，并不是一个人能控制得了的，它需要整个交付团队共同来完成。 
交付过程是每个成员的责任  

      DevOps运动的焦点和这本书的目标一直：为了更加快速且可靠地交付有价值的软件，鼓励所有参与软件交付整个过程中的人进行更好的协作。
持续改进  

      应用程序的首次发布只是其生命周期中的地一个阶段。
      在交付过程中，整个团队应该定期地坐在一起，召开回顾会议，反思一下在过去一段时间里哪些方面做得比较好，应该持续保持，哪些方面做得不太好，需要改进，并讨论一下如何改进。当下一次团队坐一起时，他们应该向大家汇报这些活动的结果。这就是众所周知的 戴明环：计划（plan），做（do），研究（study），行动（act）。
      关键在于组织中的每个人都要参与到这个过程中。避免产生一种“顽疾”：以整体优化为代价的局部优化，最终导致互相指责。

#配置管理
本书配置管理的定义： 

      配置管理是指一个过程，通过该过程，所有与项目相关的产物，以及它们之间的关系都被唯一定义、修改、存储和检索。
配置管理策略将决定如何管理项目中发生的一切变化。因此，它记录了你的系统以及应用程序的演进过程。另外，它也是对团队成员协作方式的管理。作为配置管理策略的一个结果，第二点至关重要，但常常被忽视。  
版本控制系统是配置管理中最显而易见的工具，但一个版本控制工具仅仅是制定配置管理策略的第一步。  

假如项目中有良好的配置管理策略，那么对下列所有问题的回答都应该是“YES”。  

      你能否完全再现你所需要的任何环境（这里的环境包括操作系统的版本及其补丁级别、网络配置、软件堆栈，以及部署在其上的软件应用及其配置？
      你能很轻松地对上述内容进行增量式修改，并将修改部署到任意一种或所有环境中吗？
      你能否很容易地看到已被部署到某个具体环境中的某次修改，并能追溯到修改源，知道是谁做的修改，什么时候做的修改吗？
      你能满足所有必须遵守的法规吗？
      是否每个团队成员都能很容易地得到他们所需要的信息，并进行必要的修改呢？这个配置管理策略是否会妨碍高效交付，导致周期时间增加，反馈减少呢？
本章将讨论三个问题：

      为管理应用程序的构建、部署、测试、和发布过程做好准备。从两个方面解决这个问题：对所有内容进行版本控制；管理依赖关系。
      管理应用软件的配置信息。
      整个环境的配置管理，这包括应用程序所依赖的软件、硬件和基础设施。另外还有环境管理背后的原则，包括操作系统、应用服务器、数据库和其他商业现货（COTS）软件。
##使用版本控制  

      版本控制系统（也称为源代码控制管理系统或修订控制系统）是保存文件多个版本的一种机制。当修改某个文件后，你仍旧可以访问该文件之前的任意一个修订版本。也是共同合作交付软件时所使用的一种机制。
本质上版本控制系统的目的有两个。首先，它要保留每个文件的所有版本的历史信息，并使之易于查找。这种系统还提供一种基于元数据（这些元数据用于描述数据的存储信息）的访问方式，使元数据与某个单个文件或文件集合相链接。其次，它让分布式团队（无论是空间上不在一起，还是不同的时区）可以愉快地协作。  
最关键的是能回答下面这些问题。

     对于我们开发的应用软件，某个特定的版本是由哪些文件和配置组成的？如何再现一份与生产环境一模一样的软硬件环境？
     什么时候修改了什么内容，是谁修改的，以及为什么要修改？因此，我们很容易知道应用软件在何时出了错，出错的过程，甚至出错的原因。
这是版本控制的基本原理和根本目的。  

**高效使用版本控制系统的几点建议。**  

　　__1.对所有内容进行版本控制__

&#160; &#160; &#160; &#160;使用“版本控制”（version control） 这个术语而不是“源代码控制”（source control） 的理由是，版本控制不仅仅针对源代码。每个与所开发的软件相关的产物都应被置于版本控制之下。开发人员不但要用它来管理和控制源代码，还要把测试代码、数据库脚本、构建和部署脚本、文档、库文件和应用软件所用的配置文件都纳入到版本控制之中，甚至把编译器以及工具集等也放在里面，以便让新加入项目的成员可以很容易地从零开始工作。  
　　为了重新搭建测试环境和生产环境，将所有必需的信息保存起来也是很重要的。这里必需的信息包括应用程序所需要的支撑软件的配置信息、构成对应系统环境的操作系统配置信息、DNSzone文件和防火墙配置等。至少要将那些用于重新创建应用程序的安装文件和安装环境所必需的所有信息保存在版本控制存储库之中。  
　　开发团队将所需的开发环境配置，分析人员把需求文档，测试人员把测试脚本和过程，项目经理将发布计划、进度表和风险日志也保存在版本控制存储库中。总之，每个成员都应该将与项目相关的任何文件及其修订状态保存在版本控制存储库之中。  
　　**２.频繁提交代码到主干**  
　　使用版本控制时，有两点需要牢记在心。首先，只有频繁提交代码，才能享受版本控制所带来的众多好处，比如轻松回滚到最近某个无错误的版本。  
　　其次，一旦将变更提交到版本控制中，那么团队的所有人都能看到这些变更，也能签出它。  
　　尽量使用增量方式开发新功能，并频繁且有规律的向版本控制系统提交代码。
　　提交代码之前运行测试套件（比较全面的测试集合）。很多持续集成服务器都提供名为“提交预测试”（pretested commit）的功能。
　　增量式引入变化。建议每完成一个小功能或一次重构之后就提交代码。  
　　**3.使用意义明显的提交注释**  
　　一种注释风格：第一段是简短的总结性描述，接下来的几段描述更多的细节。简短的总结性描述怎么写呢？它就像是报纸的标题一样，要给读者足够的信息，以便让读者知道是否还需要继续读下。  
　　注释中还应该包括一个链接，可以链接到项目管理工具中的一个功能或缺陷，从而知道为什么要修改这段代码。监控版本控制系统，加入注释中不包含这种信息，就无法提交代码。  
##依赖管理

　　软件项目中，最常见的外部依赖就是使用的第三方库文件。  
　　建议在本地保持一份外部库的副本（应该创建一个本地仓库，存放统一使用的外部库）。还哟强调的是，在构建系统中，应该始终指定项目所需外部库的确切版本。  

##组件管理

　　将软件分成组件开发，可让变更影响范围比较小，减少回归缺陷。还有利于重用，使大项目开发过程更加高校。  
　　将组建的构建分成不同的流水线，需要特别注意的一点是，这些构建流水线之间的依赖应该是二进制文件依赖，而不是源文件依赖。

##应用程序的配置管理
　　管理应用程序的配置，需回答三个问题：  
　　如何描述配置信息？  
　　部署脚本如何存取这些配置信息？  
　　在环境、应用程序，以及应用程序各版本之间，每个配置信息有什么不同？  
　　通常配置信息以键值对的形式来表示。可选择保存在数据库、版本控制库、文件目录或注册表等。版本控制库可能是最容易的。  
　　**1.获取配置信息**  
　　管理配置最有效的方法是让所有的应用程序通过一个中央服务系统得到它们所需要的配置信息。  
　　**2.为配置项建模**  
　　每个配置都是一个元组，所以应用程序的配置信息由一系列的元组构成。然而，这些元组及其值取决于三方面，即应用程序、该应用程序的版本、该版本所运行的环境（例如开发环境、用户验收测试环境、性能测试环境、试运行环境或生产环境）。  
　　一些在对配置信息建模时需要考虑的用例。  
* 新增一个环境（比如一个新的开发工作站，或性能测试环境）。在这种情况下你要能为这个配置应用的新环境指定一套新的配置信息。  
* 创建应用程序的一个新版本，通常需要添加一些配置设置，删除一些过时的配置设置。此时应该确保在部署新版本时，可以使用新的配置设置，但是一旦需要回滚时，还能够使用就版本的配置设置。  
* 将新版本从一个环境迁移到另一个环境，比如从测试环境挪到试运行环境。此时应该确保新环境上的新配置项都有效，而且为其设置了正确的值。  
* 重定向到一个数据库服务器。应该只需要简单地修改所有配置设置，就能让它指向新的数据库服务器。  
* 通过虚拟化技术管理环境。应该能够使用虚拟技术管理工具创建某种指定的环境，并且配置好所有的虚拟机。你也许需要将这种虚拟环境中的配置信息作为某特定版本的应用软件在虚拟环境中的标准配置信息。  

　　在不同环境之间管理配置信息的一种方法是，把预期的生产环境中的配置信息作为默认配置，而在其他环境中，通过适当的方式覆盖这些默认值（确保你有预防措施，以防生产环境收到配置失误的影响）。也就是说，尽量减少配置项，最好只保留那些与应用软件具体运行环境密切相关的配置项。  
　　**3.系统配置测试**  
　　与应用程序和构建脚本一样，配置设置也需要测试。对于系统配置测试来说，包括以下两部分。  
　　一是要保证配置设置中对外部服务的引用是良好的。最起码，要保证能够与所有的外部服务相连通。如果应用程序所依赖的任何部分没有准备好，部署或安装脚本都应该报错，这相当于配置设置的冒烟测试。  
　　二是当应用程序一旦安装好，就要在其上运行一些冒烟测试，以验证它运行正常。对于系统配置的测试，只要测试与配置有关的功能。
　　
##跨应用的配置管理  
　　在大中型组织中，通常会管理很多应用程序，而软件配置管理的复杂性也会大大增加。这种情况下，最重要的任务之一就是，要为每个应用程序维护一份所有配置选项的索引表，记录这些配置保存在什么地方，它们的生命周期是多长，以及如何修改它们。  
　　如果可能的话，运行每个应用程序的构建脚本时应该自动生产一份这类信。即便无法做到这一点，也要把它记录在Ｗiki上，或其他文档管理系统中。  
　　 目的是：系统韵味团队可以通过生产系统的监控平台了解每个软件应用的配置信息，并能看到每种环境红所运行的软件到底是哪一个版本。像Nagios、OpenNMS、和惠普的Open View都提供了记录这类信息的功能。  
　　 每个应用程序的配置项管理都应该作为项目启动阶段的一个议题，纳入计划当中。  

##管理配置信息的原则

　　创建应用程序配置信息时，应考虑以下几方面  
* 在应用程序的生命周期中，我们应该在什么时候注入哪类配置信息。是在打包的时候，还是在部署或安装的时候？是在软件启动时，还是在运行时？要与系统运维和支持团队一同讨论，看看他们有什么样的需求。
* 将应用程序的配置项与源代码保存在同一个存储库中，但要把配置项的值保存在别处。另外，配置设置与代码的生命周期完全不同，而像用户密码这类的敏感信息就不应该放到版本控制中。
* 应该总是通过自动化的过程将配置项从保存配置信息的存储库中取出并设置好，这样就能很容易地掌握不同环境中的配置信息了。
* 配置系统应该能依据应用、应用软件的版本、将要部署的环境，为打包、安装以及部署脚本提供不同的配置值。每个人都应该能够非常容易地看到当前软件的某个特定版本部署到各种环境上的具体配置信息。
* 对每个配置项都应用明确的命名习惯，避免使用晦涩难懂的名称，使其他人不需要说明手册就能明白这些配置项的含义。
* 确保配置信息是模块化且封闭的，使得对某处配置项的修改不会影响到那些与其无关的配置项。
* DRY(Don't Repeat Yourself)原则。定义好配置中的每个元素，使每个配置元素在整个系统中都是唯一的，其含义绝不与其他元素重叠。
* 最少化，即配置信息应尽可能简单且集中。除非有要求或必须使用，否则不要新增配置项
* 避免对配置信息的过分设计，应尽可能简单。
* 确保测试已覆盖到部署或安装时的配置操作。检查应用程序所依赖的其他服务是否有效，使用冒烟测试来诊断依赖于配置项的相关功能是否都能正常工作。　　

##环境管理
　　每个应用程序都依赖于硬件、软件、基础设施以及外部系统才能正常工作。我们把所有这些内容都称作应用程序的环境。  
　　应用程序的环境管理的原则：环境的配置和应用程序的配置同样重要。操作系统的配置也同样重要。　　
　　“临时决定”是管理配置信息最糟糕的方法。  
　　**_环境管理的关键在于通过一个全自动过程来创建环境，使创建全新的环境总是要比修复已受损的旧环境容易得多。原因如下_**  
* 可以避免知识遗失问题。
* 修复某个环境可能需要花费数小时的时间。所以我们最好能在可预见的时间里重建环境，并将它恢复到某个已知的正常状态下。
* 创建一个和生产环境相同的测试环境是非常必要的。对于软件配置而言，测试环境应该和生产环境一模一样。这样，配置问题更容易被在早期发现。

　　需要考虑的环境配置信息如下：  
* 环境中各种各样的操作系统，包括其版本、补丁级别以及配置设置；
* 应用程序所依赖的需要安装到每个环境中的软件包，以及这些软件包的具体版本和配置；
* 应用程序正常工作所必须的网络拓扑结构；
* 应用程序所依赖的所有外部服务，以及这些服务的版本和配置信息；
* 现有的数据以及其他相关信（比如生产数据库）。

　　***高效配置管理策略的两个基本原则:***  
　　将二进制文件与配置信息分离；  
　　将所有的配置信息保持在一处。  
　　应用了这两个基本原则，就能将“在系统不停机的情况下，创建新环境、升级系统部分功能或增加新的配置项”等工作变成一个简单的自动化过程。  
　　远程安装系统与环境管理工具（如Puppet、CfEngine）的结合使用让我们可以直接对操作系统进行集中管理和配置。  